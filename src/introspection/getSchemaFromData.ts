import {
    GraphQLID,
    GraphQLInt,
    GraphQLList,
    GraphQLNonNull,
    GraphQLObjectType,
    GraphQLInputObjectType,
    GraphQLSchema,
    GraphQLString,
    parse,
    extendSchema,
} from 'graphql';
import { pluralize, camelize } from 'inflection';

import getTypesFromData from './getTypesFromData';
import getFilterTypesFromData from './getFilterTypesFromData';
import { isRelationshipField } from '../relationships';
import { getRelatedType } from '../nameConverter';
import type { Data } from '../types';

/**
 * Get a GraphQL schema from data
 *
 * @example
 * const data = {
 *    "posts": [
 *        {
 *            "id": 1,
 *            "title": "Lorem Ipsum",
 *            "views": 254,
 *            "user_id": 123,
 *        },
 *        {
 *            "id": 2,
 *            "title": "Sic Dolor amet",
 *            "views": 65,
 *            "user_id": 456,
 *        },
 *    ],
 *    "users": [
 *        {
 *            "id": 123,
 *            "name": "John Doe"
 *        },
 *        {
 *            "id": 456,
 *            "name": "Jane Doe"
 *        }
 *    ],
 * };
 * const types = getTypesFromData(data);
 * // type Post {
 * //     id: ID
 * //     title: String
 * //     views: Int
 * //     user_id: ID
 * // }
 * //
 * // type User {
 * //     id: ID
 * //     name: String
 * // }
 * //
 * // type Query {
 * //     Post(id: ID!): Post
 * //     allPosts(page: Int, perPage: Int, sortField: String, sortOrder: String, filter: PostFilter): [Post]
 * //     User(id: ID!): User
 * //     allUsers(page: Int, perPage: Int, sortField: String, sortOrder: String, filter: UserFilter): [User]
 * // }
 * //
 * // type Mutation {
 * //     createPost(data: String): Post
 * //     updatePost(data: String): Post
 * //     removePost(id: ID!): Boolean
 * //     deletePost(id: ID!): Boolean
 * //     createUser(data: String): User
 * //     updateUser(data: String): User
 * //     removeUser(id: ID!): Boolean
 * //     deleteUser(id: ID!): Boolean
 * // }
 */
export default (data: Data) => {
    const types = getTypesFromData(data);
    const typesByName = types.reduce(
        (types, type) => {
            types[type.name] = type;
            return types;
        },
        {} as Record<string, GraphQLObjectType>,
    );

    const filterTypesByName = getFilterTypesFromData(data);

    const listMetadataType = new GraphQLObjectType({
        name: 'ListMetadata',
        fields: {
            count: { type: GraphQLInt },
        },
    });

    const queryType = new GraphQLObjectType({
        name: 'Query',
        fields: types.reduce(
            (fields, type) => {
                fields[type.name] = {
                    type: typesByName[type.name],
                    args: {
                        id: { type: new GraphQLNonNull(GraphQLID) },
                    },
                };
                fields[`all${camelize(pluralize(type.name))}`] = {
                    type: new GraphQLList(typesByName[type.name]),
                    args: {
                        page: { type: GraphQLInt },
                        perPage: { type: GraphQLInt },
                        sortField: { type: GraphQLString },
                        sortOrder: { type: GraphQLString },
                        filter: { type: filterTypesByName[type.name] },
                    },
                };
                fields[`_all${camelize(pluralize(type.name))}Meta`] = {
                    type: listMetadataType,
                    args: {
                        page: { type: GraphQLInt },
                        perPage: { type: GraphQLInt },
                        filter: { type: filterTypesByName[type.name] },
                    },
                };
                return fields;
            },
            {} as Record<string, any>,
        ),
    });

    const mutationType = new GraphQLObjectType({
        name: 'Mutation',
        fields: types.reduce(
            (fields, type) => {
                const typeFields = typesByName[type.name].getFields();
                const nullableTypeFields = Object.keys(typeFields).reduce(
                    (f, fieldName) => {
                        f[fieldName] = Object.assign(
                            {},
                            typeFields[fieldName],
                            {
                                type:
                                    fieldName !== 'id' &&
                                    typeFields[fieldName].type instanceof
                                        GraphQLNonNull
                                        ? typeFields[fieldName].type.ofType
                                        : typeFields[fieldName].type,
                            },
                        );
                        return f;
                    },
                    {} as Record<string, any>,
                );
                const { id, ...createFields } = typeFields;

                // Build input type.
                const inputFields = Object.keys(createFields).reduce(
                    (f, fieldName) => {
                        f[fieldName] = Object.assign(
                            {},
                            createFields[fieldName],
                        );
                        // biome-ignore lint/performance/noDelete: <explanation>
                        delete f[fieldName].resolve;
                        return f;
                    },
                    {} as Record<string, any>,
                );

                const createManyInputType = new GraphQLInputObjectType({
                    name: `${type.name}Input`,
                    fields: inputFields,
                });

                fields[`create${type.name}`] = {
                    type: typesByName[type.name],
                    args: createFields,
                };
                fields[`createMany${type.name}`] = {
                    type: new GraphQLList(typesByName[type.name]),
                    args: {
                        data: {
                            type: new GraphQLList(createManyInputType),
                        },
                    },
                };
                fields[`update${type.name}`] = {
                    type: typesByName[type.name],
                    args: nullableTypeFields,
                };
                fields[`remove${type.name}`] = {
                    type: typesByName[type.name],
                    args: {
                        id: { type: new GraphQLNonNull(GraphQLID) },
                    },
                };
                fields[`delete${type.name}`] = {
                    type: typesByName[type.name],
                    args: {
                        id: { type: new GraphQLNonNull(GraphQLID) },
                    },
                };
                return fields;
            },
            {} as Record<string, any>,
        ),
    });

    const schema = new GraphQLSchema({
        query: queryType,
        mutation: mutationType,
    });

    /**
     * extend schema to add relationship fields
     *
     * @example
     * If the `post` key contains a 'user_id' field, then
     * add one-to-many and many-to-one type extensions:
     *     extend type Post { User: User }
     *     extend type User { Posts: [Post] }
     */

    const schemaExtension = Object.values(typesByName).reduce((ext, type) => {
        let newExtension = `${ext}`;
        for (const fieldName of Object.keys(type.getFields()).filter(
            isRelationshipField,
        )) {
            const relType = getRelatedType(fieldName);
            const rel = pluralize(type.toString());
            newExtension = `${newExtension}
    extend type ${type} { ${relType}: ${relType} }
    extend type ${relType} { ${rel}: [${type}] }`;
        }
        return newExtension;
    }, '');

    return schemaExtension
        ? extendSchema(schema, parse(schemaExtension))
        : schema;
};
